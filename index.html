<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Control - Marine Farm</title>
    <style>
        /* =========================
           MARINE FARM V2 - DISEÑO APROBADO
           ========================= */
        :root {
          --mf-blue: #0c3e4d;
          --mf-blue-dark: #073240;
          --mf-blue-light: #e8f4f8;
          --mf-orange: #ff6c37;
          --mf-white: #ffffff;
          --mf-grey: #d6d1ca;
          --mf-grey-light: #f8f9fa;
          --mf-grey-medium: #e9ecef;
          --mf-text: #073240;
          --mf-text-light: #6c757d;
          --mf-green: #41695b;
          --mf-border: #dee2e6;
          --radius-sm: 8px;
          --radius-md: 12px;
          --radius-lg: 16px;
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
          --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
          --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
          background: var(--mf-grey-light);
          color: var(--mf-text);
          line-height: 1.5;
        }

        /* =========================
           LAYOUT
           ========================= */
        .app-container {
          display: flex;
          min-height: 100vh;
        }

        /* =========================
           SIDEBAR - Minimalista
           ========================= */
        .sidebar {
          width: 220px;
          background: var(--mf-blue-dark);
          display: flex;
          flex-direction: column;
          padding: 24px 16px;
          position: sticky;
          top: 0;
          height: 100vh;
          overflow-y: auto;
        }

        .sidebar-logo {
          margin-bottom: 8px;
        }

        .sidebar-logo img {
          width: 160px;
          height: auto;
        }

        .sidebar-subtitle {
          font-size: 11px;
          color: rgba(255, 255, 255, 0.7);
          text-transform: uppercase;
          letter-spacing: 1px;
          font-weight: 600;
          margin-bottom: 32px;
        }

        .nav-section {
          margin-bottom: 24px;
        }

        .nav-section-title {
          font-size: 10px;
          color: rgba(255, 255, 255, 0.5);
          text-transform: uppercase;
          letter-spacing: 1.2px;
          font-weight: 700;
          margin-bottom: 8px;
          padding: 0 12px;
        }

        .nav-item {
          padding: 10px 12px;
          color: rgba(255, 255, 255, 0.85);
          border-radius: var(--radius-sm);
          cursor: pointer;
          transition: all 0.2s;
          font-size: 14px;
          font-weight: 500;
          border: none;
          background: transparent;
          width: 100%;
          text-align: left;
          display: block;
        }

        .nav-item:hover {
          background: rgba(255, 255, 255, 0.1);
          color: white;
        }

        .nav-item.active {
          background: rgba(255, 255, 255, 0.15);
          color: white;
          font-weight: 600;
        }

        .sidebar-footer {
          margin-top: auto;
          padding-top: 16px;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
          font-size: 11px;
          color: rgba(255, 255, 255, 0.5);
        }

        /* =========================
           MAIN CONTENT
           ========================= */
        .main-content {
          flex: 1;
          background: var(--mf-grey-light);
        }

        .topbar {
          background: white;
          padding: 20px 32px;
          border-bottom: 1px solid var(--mf-border);
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 24px;
          flex-wrap: wrap;
        }

        .topbar-left {
          display: flex;
          align-items: center;
          gap: 16px;
        }

        .topbar-logo {
          width: 48px;
          height: 48px;
          object-fit: contain;
        }

        .page-title {
          font-size: 28px;
          font-weight: 700;
          color: var(--mf-blue-dark);
          margin: 0;
          line-height: 1.2;
        }

        .page-subtitle {
          font-size: 14px;
          color: var(--mf-text-light);
          margin-top: 2px;
        }

        .topbar-filters {
          display: flex;
          gap: 12px;
          align-items: center;
        }

        .filter-input {
          padding: 8px 16px;
          border: 1px solid var(--mf-border);
          border-radius: var(--radius-sm);
          font-size: 14px;
          min-width: 180px;
          transition: border-color 0.2s;
        }

        .filter-input:focus {
          outline: none;
          border-color: var(--mf-blue);
        }

        .filter-input::placeholder {
          color: var(--mf-text-light);
        }

        .btn {
          padding: 8px 16px;
          border-radius: var(--radius-sm);
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s;
          border: none;
          display: inline-flex;
          align-items: center;
          gap: 8px;
        }

        .btn-primary {
          background: var(--mf-orange);
          color: white;
        }

        .btn-primary:hover {
          background: #e55a2a;
          transform: translateY(-1px);
        }

        .btn-secondary {
          background: white;
          color: var(--mf-blue);
          border: 1px solid var(--mf-border);
        }

        .btn-secondary:hover {
          border-color: var(--mf-blue);
          background: var(--mf-blue-light);
        }

        .btn-sm {
          padding: 6px 12px;
          font-size: 13px;
        }

        /* =========================
           CONTENT AREA
           ========================= */
        .content {
          padding: 32px;
        }

        /* =========================
           KPI GRID - Compacto
           ========================= */
        .kpi-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 20px;
          margin-bottom: 32px;
        }

        .kpi-card {
          background: white;
          padding: 20px;
          border-radius: var(--radius-md);
          border: 1px solid var(--mf-border);
          transition: all 0.2s;
        }

        .kpi-card:hover {
          box-shadow: var(--shadow-md);
          transform: translateY(-2px);
        }

        .kpi-label {
          font-size: 12px;
          color: var(--mf-text-light);
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 8px;
        }

        .kpi-value {
          font-size: 32px;
          font-weight: 700;
          color: var(--mf-blue-dark);
          line-height: 1;
          margin-bottom: 8px;
        }

        .kpi-subtitle {
          font-size: 13px;
          color: var(--mf-text-light);
          font-weight: 500;
        }

        /* =========================
           CARDS
           ========================= */
        .card {
          background: white;
          border-radius: var(--radius-md);
          border: 1px solid var(--mf-border);
          overflow: hidden;
          margin-bottom: 24px;
        }

        .card-header {
          padding: 20px 24px;
          border-bottom: 1px solid var(--mf-border);
          background: white;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .card-title {
          font-size: 18px;
          font-weight: 700;
          color: var(--mf-blue-dark);
        }

        .card-body {
          padding: 0;
        }

        /* =========================
           TABLES
           ========================= */
        .table-container {
          overflow-x: auto;
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }

        thead {
          background: var(--mf-grey-light);
        }

        th {
          padding: 12px 20px;
          text-align: left;
          font-size: 12px;
          font-weight: 700;
          color: var(--mf-text-light);
          text-transform: uppercase;
          letter-spacing: 0.5px;
          border-bottom: 2px solid var(--mf-border);
        }

        td {
          padding: 16px 20px;
          font-size: 14px;
          color: var(--mf-text);
          border-bottom: 1px solid var(--mf-grey-medium);
        }

        tbody tr {
          transition: background 0.15s;
          cursor: pointer;
        }

        tbody tr:hover {
          background: var(--mf-blue-light);
        }

        /* =========================
           BADGES
           ========================= */
        .badge {
          display: inline-block;
          padding: 4px 10px;
          border-radius: 12px;
          font-size: 11px;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .badge-success {
          background: #d4edda;
          color: #155724;
        }

        .badge-warning {
          background: #fff3cd;
          color: #856404;
        }

        .badge-danger {
          background: #f8d7da;
          color: #721c24;
        }

        .badge-info {
          background: #d1ecf1;
          color: #0c5460;
        }

        .badge-secondary {
          background: var(--mf-grey-medium);
          color: var(--mf-text-light);
        }

        /* =========================
           PRIORITY DOTS
           ========================= */
        .priority-dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          display: inline-block;
          margin-right: 8px;
        }

        .priority-1 { background: #dc3545; }
        .priority-2 { background: #ffc107; }
        .priority-3 { background: #28a745; }

        /* =========================
           MODAL
           ========================= */
        .modal {
          display: none;
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          align-items: center;
          justify-content: center;
          padding: 20px;
        }

        .modal.active {
          display: flex;
        }

        .modal-content {
          background: white;
          border-radius: var(--radius-lg);
          max-width: 600px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: var(--shadow-lg);
        }

        .modal-header {
          padding: 24px;
          border-bottom: 1px solid var(--mf-border);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .modal-title {
          font-size: 20px;
          font-weight: 700;
          color: var(--mf-blue-dark);
        }

        .modal-body {
          padding: 24px;
        }

        .modal-footer {
          padding: 16px 24px;
          border-top: 1px solid var(--mf-border);
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          background: var(--mf-grey-light);
        }

        /* =========================
           FORMS
           ========================= */
        .form-group {
          margin-bottom: 20px;
        }

        .form-label {
          display: block;
          font-size: 13px;
          font-weight: 600;
          color: var(--mf-text);
          margin-bottom: 6px;
        }

        .form-input,
        .form-select,
        .form-textarea {
          width: 100%;
          padding: 10px 14px;
          border: 1px solid var(--mf-border);
          border-radius: var(--radius-sm);
          font-size: 14px;
          transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
          outline: none;
          border-color: var(--mf-blue);
        }

        .form-textarea {
          min-height: 100px;
          resize: vertical;
        }

        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
        }

        /* =========================
           UTILITIES
           ========================= */
        .page {
          display: none;
        }

        .page.active {
          display: block;
        }

        .text-center {
          text-align: center;
        }

        .text-muted {
          color: var(--mf-text-light);
        }

        .mt-2 { margin-top: 16px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }

        /* =========================
           DRAWER
           ========================= */
        .drawer-overlay {
          display: none;
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.3);
          z-index: 900;
        }

        .drawer-overlay.active {
          display: block;
        }

        .drawer {
          position: fixed;
          top: 0;
          right: 0;
          width: 400px;
          height: 100vh;
          background: white;
          box-shadow: var(--shadow-lg);
          z-index: 1000;
          transform: translateX(100%);
          transition: transform 0.3s;
          display: flex;
          flex-direction: column;
        }

        .drawer.active {
          transform: translateX(0);
        }

        .drawer-header {
          padding: 24px;
          border-bottom: 1px solid var(--mf-border);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .drawer-body {
          padding: 24px;
          overflow-y: auto;
          flex: 1;
        }

        .detail-row {
          display: grid;
          grid-template-columns: 120px 1fr;
          gap: 12px;
          padding: 12px 0;
          border-bottom: 1px solid var(--mf-grey-medium);
        }

        .detail-label {
          font-size: 13px;
          color: var(--mf-text-light);
          font-weight: 600;
        }

        .detail-value {
          font-size: 14px;
          color: var(--mf-text);
          font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
          .app-container {
            flex-direction: column;
          }

          .sidebar {
            width: 100%;
            height: auto;
            position: relative;
          }

          .topbar {
            flex-direction: column;
            align-items: flex-start;
          }

          .content {
            padding: 20px;
          }

          .kpi-grid {
            grid-template-columns: 1fr;
          }

          .form-row {
            grid-template-columns: 1fr;
          }
        }

        .empty-state {
          padding: 60px 20px;
          text-align: center;
        }

        .empty-state-icon {
          font-size: 48px;
          margin-bottom: 16px;
          opacity: 0.3;
        }

        .empty-state-text {
          color: var(--mf-text-light);
          font-size: 15px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="logo-white.png" alt="Marine Farm">
            </div>
            <div class="sidebar-subtitle">TORRE DE CONTROL</div>

            <nav>
                <div class="nav-section">
                    <div class="nav-section-title">PRINCIPAL</div>
                    <button class="nav-item active" onclick="navigateTo('dashboard')">
                        Dashboard
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">OPERACIONES</div>
                    <button class="nav-item" onclick="navigateTo('requests')">
                        Solicitudes
                    </button>
                    <button class="nav-item" onclick="navigateTo('orders')">
                        Pedidos
                    </button>
                    <button class="nav-item" onclick="navigateTo('shipments')">
                        En Tránsito
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">REPORTES</div>
                    <button class="nav-item" onclick="navigateTo('payments')">
                        Pagos
                    </button>
                    <button class="nav-item" onclick="navigateTo('kpi')">
                        KPI Comercial
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                v1.0.0 | Marine Farm 2026
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- DASHBOARD PAGE -->
            <div id="page-dashboard" class="page active">
                <div class="topbar">
                    <div class="topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="topbar-logo">
                        <div>
                            <h1 class="page-title">Dashboard Ejecutivo</h1>
                            <p class="page-subtitle">Panorama general de operaciones</p>
                        </div>
                    </div>
                    <div class="topbar-filters">
                        <input type="text" class="filter-input" placeholder="Cliente" id="filter-customer">
                        <input type="text" class="filter-input" placeholder="País" id="filter-country">
                        <button class="btn btn-secondary btn-sm" onclick="clearFilters()">Limpiar</button>
                    </div>
                </div>

                <div class="content">
                    <!-- KPIs -->
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">Pedidos Activos</div>
                            <div class="kpi-value" id="kpi-orders">0</div>
                            <div class="kpi-subtitle">En backlog</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">En Tránsito</div>
                            <div class="kpi-value" id="kpi-shipments">0</div>
                            <div class="kpi-subtitle">Contenedores activos</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Volumen Mes (KG)</div>
                            <div class="kpi-value" id="kpi-volume">0</div>
                            <div class="kpi-subtitle">Pendiente despacho</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">ETA Hoy</div>
                            <div class="kpi-value" id="kpi-eta-today">0</div>
                            <div class="kpi-subtitle">Llegadas programadas</div>
                        </div>
                    </div>

                    <!-- Alerts Table -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Alertas Críticas</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">P</th>
                                            <th>PI</th>
                                            <th>Cliente</th>
                                            <th>Tipo</th>
                                            <th>Alerta</th>
                                        </tr>
                                    </thead>
                                    <tbody id="alerts-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REQUESTS PAGE -->
            <div id="page-requests" class="page">
                <div class="topbar">
                    <div class="topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="topbar-logo">
                        <div>
                            <h1 class="page-title">Solicitudes de Pedido</h1>
                            <p class="page-subtitle">Gestión de order requests</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="openNewRequestModal()">
                        + Nueva Solicitud
                    </button>
                </div>

                <div class="content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Todas las Solicitudes</h3>
                            <button class="btn btn-secondary btn-sm">Exportar CSV</button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Cliente</th>
                                            <th>Destino</th>
                                            <th>ETD</th>
                                            <th>Volumen (KG)</th>
                                            <th>Estado</th>
                                            <th>Comercial</th>
                                            <th style="width: 200px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="requests-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ORDERS PAGE -->
            <div id="page-orders" class="page">
                <div class="topbar">
                    <div class="topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="topbar-logo">
                        <div>
                            <h1 class="page-title">Pedidos (Backlog)</h1>
                            <p class="page-subtitle">Órdenes confirmadas pendientes de embarque</p>
                        </div>
                    </div>
                </div>

                <div class="content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Todos los Pedidos</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">P</th>
                                            <th>PI</th>
                                            <th>Cliente</th>
                                            <th>País</th>
                                            <th>Producto</th>
                                            <th>ETD</th>
                                            <th>Pendiente KG</th>
                                            <th>USD/KG</th>
                                            <th>SI</th>
                                            <th style="width: 150px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orders-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SHIPMENTS PAGE -->
            <div id="page-shipments" class="page">
                <div class="topbar">
                    <div class="topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="topbar-logo">
                        <div>
                            <h1 class="page-title">Embarques en Tránsito</h1>
                            <p class="page-subtitle">Seguimiento de contenedores</p>
                        </div>
                    </div>
                </div>

                <div class="content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Contenedores Activos</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Booking</th>
                                            <th>PI</th>
                                            <th>Cliente</th>
                                            <th>Destino</th>
                                            <th>ETD</th>
                                            <th>ETA</th>
                                            <th>KG</th>
                                            <th>Docs</th>
                                            <th style="width: 150px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shipments-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAYMENTS PAGE -->
            <div id="page-payments" class="page">
                <div class="topbar">
                    <div class="topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="topbar-logo">
                        <div>
                            <h1 class="page-title">Status de Pagos</h1>
                            <p class="page-subtitle">Control de cobranzas</p>
                        </div>
                    </div>
                </div>

                <div class="content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Por Cliente</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Deuda USD</th>
                                            <th>Línea Crédito</th>
                                            <th>Disponible</th>
                                            <th>Días Atraso</th>
                                            <th style="width: 120px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="payments-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPI PAGE -->
            <div id="page-kpi" class="page">
                <div class="topbar">
                    <div class="topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="topbar-logo">
                        <div>
                            <h1 class="page-title">KPI Comercial</h1>
                            <p class="page-subtitle">Métricas de desempeño</p>
                        </div>
                    </div>
                </div>

                <div class="content">
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">Órdenes Cerradas</div>
                            <div class="kpi-value" id="kpi-closed">0</div>
                            <div class="kpi-subtitle">Este mes</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Volumen Exportado</div>
                            <div class="kpi-value" id="kpi-exported">0</div>
                            <div class="kpi-subtitle">KG</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">OTIF</div>
                            <div class="kpi-value" id="kpi-otif">0%</div>
                            <div class="kpi-subtitle">On-Time In-Full</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">Margen Promedio</div>
                            <div class="kpi-value" id="kpi-margin">$0</div>
                            <div class="kpi-subtitle">USD/KG</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Mix de Especies</h3>
                        </div>
                        <div class="card-body" style="padding: 24px;">
                            <div style="margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">Atlantic Salmon</span>
                                    <span style="font-weight: 700; color: var(--mf-blue);">70%</span>
                                </div>
                                <div style="background: var(--mf-grey-medium); height: 32px; border-radius: 8px; overflow: hidden;">
                                    <div style="background: var(--mf-blue); height: 100%; width: 70%; border-radius: 8px;"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">Coho Salmon</span>
                                    <span style="font-weight: 700; color: var(--mf-orange);">25%</span>
                                </div>
                                <div style="background: var(--mf-grey-medium); height: 32px; border-radius: 8px; overflow: hidden;">
                                    <div style="background: var(--mf-orange); height: 100%; width: 25%; border-radius: 8px;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="font-weight: 600;">Otros</span>
                                    <span style="font-weight: 700; color: var(--mf-text-light);">5%</span>
                                </div>
                                <div style="background: var(--mf-grey-medium); height: 32px; border-radius: 8px; overflow: hidden;">
                                    <div style="background: var(--mf-text-light); height: 100%; width: 5%; border-radius: 8px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- NEW REQUEST MODAL -->
    <div id="new-request-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nueva Solicitud de Pedido</h3>
                <button class="btn btn-secondary btn-sm" onclick="closeModal()">×</button>
            </div>
            <form id="new-request-form" onsubmit="submitNewRequest(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <input type="text" class="form-input" name="client" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Incoterm *</label>
                            <select class="form-select" name="incoterm" required>
                                <option value="CFR">CFR</option>
                                <option value="FOB">FOB</option>
                                <option value="CIF">CIF</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Destino *</label>
                            <input type="text" class="form-input" name="destination" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ETD Mes *</label>
                            <input type="month" class="form-input" name="etdMonth" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Volumen (KG) *</label>
                            <input type="number" class="form-input" name="volume" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Producto *</label>
                        <input type="text" class="form-input" name="product" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Precio (USD/KG) *</label>
                        <input type="number" step="0.01" class="form-input" name="price" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comentarios</label>
                        <textarea class="form-textarea" name="comments"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Solicitud</button>
                </div>
            </form>
        </div>
    </div>

    <!-- DRAWER -->
    <div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>
    <div class="drawer" id="drawer">
        <div class="drawer-header">
            <h3 class="modal-title" id="drawer-title">Detalles</h3>
            <button class="btn btn-secondary btn-sm" onclick="closeDrawer()">×</button>
        </div>
        <div class="drawer-body" id="drawer-body"></div>
    </div>

    <script>
        // ==================== DATA STORAGE ====================
        const STORAGE_KEYS = {
            orders: 'mf.orders.v2',
            requests: 'mf.requests.v2',
            shipments: 'mf.shipments.v2',
            delivered: 'mf.delivered.v2',
            payments: 'mf.payments.v2'
        };

        const seedData = {
            requests: [
                {
                    id: 'REQ-3001',
                    requester: 'Nicolas',
                    client: 'Vietnam Importer A',
                    incoterm: 'CFR',
                    destination: 'HCMC, Vietnam',
                    shipmentEtdMonth: '2026-02',
                    items: [{product: 'Coho HG IQF', volume: 20000}],
                    status: 'ENVIADA',
                    createdAt: '2026-01-15T10:00:00Z'
                },
                {
                    id: 'REQ-3002',
                    requester: 'Nicolas',
                    client: 'Thai Distributor A',
                    incoterm: 'CFR',
                    destination: 'Bangkok, Thailand',
                    shipmentEtdMonth: '2026-02',
                    items: [{product: 'Atlantic HON', volume: 20000}],
                    status: 'EN_REVISION',
                    createdAt: '2026-01-18T14:30:00Z'
                }
            ],
            orders: [
                {
                    id: 'ORD-001',
                    pi: 'PI-45621',
                    customer: 'Vietnam Importer A',
                    country: 'VIETNAM',
                    destination: 'CFR HCMC',
                    product: 'Coho HG IQF 9lbs Up',
                    etd: '2026-02-15',
                    pendingKg: 20000,
                    priceUsdPerKg: 6.80,
                    priority: 1,
                    commercial: 'Nicolas',
                    shippingInstructionsOk: false
                },
                {
                    id: 'ORD-002',
                    pi: 'PI-45622',
                    customer: 'Thai Distributor A',
                    country: 'THAILAND',
                    destination: 'CFR Bangkok',
                    product: 'Atlantic HON 6-7',
                    etd: '2026-02-20',
                    pendingKg: 20000,
                    priceUsdPerKg: 5.62,
                    priority: 2,
                    commercial: 'Nicolas',
                    shippingInstructionsOk: true
                }
            ],
            shipments: [
                {
                    id: 'SHIP-001',
                    pi: 'PI-45618',
                    booking: 'MAEU9876543',
                    customer: 'China Trader A',
                    country: 'CHINA',
                    destination: 'CFR Shanghai',
                    product: 'Atlantic HON Mix',
                    etd: '2026-01-15',
                    eta: '2026-02-05',
                    shippedKg: 20000,
                    docsStatus: 'OK',
                    priceUsdPerKg: 5.45
                },
                {
                    id: 'SHIP-002',
                    pi: 'PI-45619',
                    booking: 'COSU1234567',
                    customer: 'Korea Fish Co',
                    country: 'KOREA',
                    destination: 'CFR Busan',
                    product: 'Coho Portions',
                    etd: '2026-01-20',
                    eta: '2026-01-30',
                    shippedKg: 18000,
                    docsStatus: 'PEND',
                    priceUsdPerKg: 6.95
                }
            ],
            delivered: [],
            payments: [
                {
                    customer: 'Vietnam Importer A',
                    debtUsd: 145000,
                    creditLineUsd: 300000,
                    maxDaysOverdue: 45
                },
                {
                    customer: 'Thai Distributor A',
                    debtUsd: 95000,
                    creditLineUsd: 200000,
                    maxDaysOverdue: 29
                }
            ]
        };

        let appState = {
            requests: [],
            orders: [],
            shipments: [],
            delivered: [],
            payments: [],
            filters: { customer: '', country: '' }
        };

        // ==================== INIT ====================
        function initApp() {
            Object.keys(STORAGE_KEYS).forEach(key => {
                const stored = localStorage.getItem(STORAGE_KEYS[key]);
                appState[key] = stored ? JSON.parse(stored) : seedData[key] || [];
            });

            document.getElementById('filter-customer')?.addEventListener('input', () => {
                appState.filters.customer = document.getElementById('filter-customer').value;
                renderCurrentPage();
            });

            document.getElementById('filter-country')?.addEventListener('input', () => {
                appState.filters.country = document.getElementById('filter-country').value;
                renderCurrentPage();
            });

            renderCurrentPage();
        }

        function saveToStorage(key) {
            localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(appState[key]));
        }

        // ==================== NAVIGATION ====================
        function navigateTo(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const activePage = document.querySelector('.page.active');
            if (!activePage) return;

            const pageId = activePage.id;
            switch(pageId) {
                case 'page-dashboard': renderDashboard(); break;
                case 'page-requests': renderRequests(); break;
                case 'page-orders': renderOrders(); break;
                case 'page-shipments': renderShipments(); break;
                case 'page-payments': renderPayments(); break;
                case 'page-kpi': renderKPI(); break;
            }
        }

        // ==================== UTILITIES ====================
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('es-CL');
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('es-CL').format(num || 0);
        }

        function clearFilters() {
            appState.filters = {customer: '', country: ''};
            document.getElementById('filter-customer').value = '';
            document.getElementById('filter-country').value = '';
            renderCurrentPage();
        }

        function applyFilters(items) {
            return items.filter(item => {
                const customer = (item.customer || item.client || '').toLowerCase();
                const country = (item.country || item.destination || '').toLowerCase();
                if (appState.filters.customer && !customer.includes(appState.filters.customer.toLowerCase())) return false;
                if (appState.filters.country && !country.includes(appState.filters.country.toLowerCase())) return false;
                return true;
            });
        }

        function getStatusBadgeClass(status) {
            const map = {
                'OK': 'badge-success', 'PI CREADA': 'badge-success',
                'PEND': 'badge-warning', 'EN_REVISION': 'badge-warning', 'BORRADOR': 'badge-warning',
                'ENVIADA': 'badge-info', 'DRAFT ENVIADO': 'badge-info',
                'RECHAZADA': 'badge-danger'
            };
            return map[status] || 'badge-secondary';
        }

        // ==================== RENDER FUNCTIONS ====================
        function renderDashboard() {
            const filtered = {
                orders: applyFilters(appState.orders),
                shipments: applyFilters(appState.shipments)
            };

            document.getElementById('kpi-orders').textContent = filtered.orders.length;
            document.getElementById('kpi-shipments').textContent = filtered.shipments.length;
            document.getElementById('kpi-volume').textContent = formatNumber(filtered.orders.reduce((sum, o) => sum + (o.pendingKg || 0), 0));
            document.getElementById('kpi-eta-today').textContent = 0;

            const alerts = [];
            filtered.orders.filter(o => !o.shippingInstructionsOk).slice(0, 3).forEach(o => {
                alerts.push({priority: o.priority, pi: o.pi, customer: o.customer, type: 'SI PEND', message: 'Shipping Instructions pendientes'});
            });

            const tbody = document.getElementById('alerts-tbody');
            if (alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-text">✓ No hay alertas críticas</div></td></tr>';
            } else {
                tbody.innerHTML = alerts.map(a => `
                    <tr>
                        <td><span class="priority-dot priority-${a.priority}"></span></td>
                        <td><strong>${a.pi}</strong></td>
                        <td>${a.customer}</td>
                        <td><span class="badge ${getStatusBadgeClass(a.type)}">${a.type}</span></td>
                        <td>${a.message}</td>
                    </tr>
                `).join('');
            }
        }

        function renderRequests() {
            const filtered = applyFilters(appState.requests);
            const tbody = document.getElementById('requests-tbody');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-text">No hay solicitudes</div></td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(r => {
                const totalVolume = r.items.reduce((sum, i) => sum + (i.volume || 0), 0);
                return `
                    <tr onclick="viewRequestDetails('${r.id}')">
                        <td><strong>${r.id}</strong></td>
                        <td>${r.client}</td>
                        <td>${r.incoterm} ${r.destination}</td>
                        <td>${r.shipmentEtdMonth}</td>
                        <td>${formatNumber(totalVolume)}</td>
                        <td><span class="badge ${getStatusBadgeClass(r.status)}">${r.status}</span></td>
                        <td>${r.requester}</td>
                        <td>
                            ${r.status === 'ENVIADA' || r.status === 'EN_REVISION' ? 
                                `<button class="btn btn-primary btn-sm" onclick="approveRequest('${r.id}', event)">Aprobar</button>` : ''}
                            <button class="btn btn-secondary btn-sm" onclick="deleteRequest('${r.id}', event)">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderOrders() {
            const filtered = applyFilters(appState.orders);
            const tbody = document.getElementById('orders-tbody');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><div class="empty-state-text">No hay pedidos</div></td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(o => `
                <tr>
                    <td><span class="priority-dot priority-${o.priority}"></span></td>
                    <td><strong>${o.pi}</strong></td>
                    <td>${o.customer}</td>
                    <td>${o.country}</td>
                    <td>${o.product}</td>
                    <td>${formatDate(o.etd)}</td>
                    <td>${formatNumber(o.pendingKg)}</td>
                    <td>$${o.priceUsdPerKg.toFixed(2)}</td>
                    <td><span class="badge ${o.shippingInstructionsOk ? 'badge-success' : 'badge-warning'}">${o.shippingInstructionsOk ? 'OK' : 'PEND'}</span></td>
                    <td><button class="btn btn-primary btn-sm" onclick="shipOrder('${o.id}')">Embarcar</button></td>
                </tr>
            `).join('');
        }

        function renderShipments() {
            const filtered = applyFilters(appState.shipments);
            const tbody = document.getElementById('shipments-tbody');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="empty-state-text">No hay embarques</div></td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(s => `
                <tr>
                    <td><strong>${s.booking}</strong></td>
                    <td>${s.pi || '-'}</td>
                    <td>${s.customer}</td>
                    <td>${s.destination}</td>
                    <td>${formatDate(s.etd)}</td>
                    <td>${formatDate(s.eta)}</td>
                    <td>${formatNumber(s.shippedKg)}</td>
                    <td><span class="badge ${getStatusBadgeClass(s.docsStatus)}">${s.docsStatus}</span></td>
                    <td><button class="btn btn-primary btn-sm" onclick="confirmDelivery('${s.id}')">Entregado</button></td>
                </tr>
            `).join('');
        }

        function renderPayments() {
            const tbody = document.getElementById('payments-tbody');

            if (appState.payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-text">No hay datos de pagos</div></td></tr>';
                return;
            }

            tbody.innerHTML = appState.payments.map(p => {
                const available = p.creditLineUsd - p.debtUsd;
                const daysClass = p.maxDaysOverdue > 60 ? 'badge-danger' : p.maxDaysOverdue > 30 ? 'badge-warning' : 'badge-success';
                return `
                    <tr>
                        <td><strong>${p.customer}</strong></td>
                        <td>$${formatNumber(p.debtUsd)}</td>
                        <td>$${formatNumber(p.creditLineUsd)}</td>
                        <td>$${formatNumber(available)}</td>
                        <td><span class="badge ${daysClass}">${p.maxDaysOverdue} días</span></td>
                        <td><button class="btn btn-secondary btn-sm">Ver Detalle</button></td>
                    </tr>
                `;
            }).join('');
        }

        function renderKPI() {
            const closedThisMonth = appState.delivered.filter(d => {
                const deliveredDate = new Date(d.deliveredAt);
                const now = new Date();
                return deliveredDate.getMonth() === now.getMonth() && deliveredDate.getFullYear() === now.getFullYear();
            });

            document.getElementById('kpi-closed').textContent = closedThisMonth.length;
            document.getElementById('kpi-exported').textContent = formatNumber(closedThisMonth.reduce((sum, d) => sum + (d.shippedKg || 0), 0));
            document.getElementById('kpi-otif').textContent = closedThisMonth.length > 0 ? '92%' : '0%';
            const avgMargin = closedThisMonth.length > 0 ? closedThisMonth.reduce((sum, d) => sum + (d.priceUsdPerKg || 0), 0) / closedThisMonth.length : 0;
            document.getElementById('kpi-margin').textContent = `$${avgMargin.toFixed(2)}`;
        }

        // ==================== ACTIONS ====================
        function viewRequestDetails(requestId) {
            const request = appState.requests.find(r => r.id === requestId);
            if (!request) return;

            document.getElementById('drawer-title').textContent = `Solicitud ${request.id}`;
            document.getElementById('drawer-body').innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Cliente</div>
                    <div class="detail-value">${request.client}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Estado</div>
                    <div class="detail-value"><span class="badge ${getStatusBadgeClass(request.status)}">${request.status}</span></div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Destino</div>
                    <div class="detail-value">${request.incoterm} ${request.destination}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">ETD</div>
                    <div class="detail-value">${request.shipmentEtdMonth}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Comercial</div>
                    <div class="detail-value">${request.requester}</div>
                </div>
            `;
            openDrawer();
        }

        function approveRequest(requestId, event) {
            event?.stopPropagation();
            if (!confirm('¿Aprobar esta solicitud y crear pedido?')) return;

            const request = appState.requests.find(r => r.id === requestId);
            if (!request) return;

            const totalVolume = request.items.reduce((sum, i) => sum + (i.volume || 0), 0);
            const newOrder = {
                id: `ORD-${String(appState.orders.length + 1).padStart(3, '0')}`,
                pi: `PI-${Math.floor(10000 + Math.random() * 90000)}`,
                customer: request.client,
                country: request.destination.includes('Vietnam') ? 'VIETNAM' : 'OTRO',
                destination: `${request.incoterm} ${request.destination}`,
                product: request.items[0].product,
                etd: `${request.shipmentEtdMonth}-15`,
                pendingKg: totalVolume,
                priceUsdPerKg: 6.50,
                priority: 2,
                commercial: request.requester,
                shippingInstructionsOk: false
            };

            appState.orders.unshift(newOrder);
            request.status = 'PI CREADA';
            saveToStorage('orders');
            saveToStorage('requests');
            renderCurrentPage();
            alert(`Pedido ${newOrder.pi} creado exitosamente`);
        }

        function deleteRequest(requestId, event) {
            event?.stopPropagation();
            if (!confirm('¿Eliminar esta solicitud?')) return;
            appState.requests = appState.requests.filter(r => r.id !== requestId);
            saveToStorage('requests');
            renderCurrentPage();
        }

        function shipOrder(orderId) {
            const order = appState.orders.find(o => o.id === orderId);
            if (!order) return;

            const booking = prompt('Ingrese número de booking:');
            if (!booking) return;

            const eta = prompt('Ingrese ETA (YYYY-MM-DD):');
            if (!eta) return;

            const newShipment = {
                id: `SHIP-${String(appState.shipments.length + 1).padStart(3, '0')}`,
                pi: order.pi,
                booking: booking,
                customer: order.customer,
                country: order.country,
                destination: order.destination,
                product: order.product,
                etd: order.etd,
                eta: eta,
                shippedKg: order.pendingKg,
                docsStatus: 'PEND',
                priceUsdPerKg: order.priceUsdPerKg
            };

            appState.shipments.unshift(newShipment);
            appState.orders = appState.orders.filter(o => o.id !== orderId);
            saveToStorage('shipments');
            saveToStorage('orders');
            alert(`Embarque ${newShipment.booking} creado exitosamente`);
            navigateTo('shipments');
        }

        function confirmDelivery(shipmentId) {
            if (!confirm('¿Confirmar entrega de este embarque?')) return;

            const shipment = appState.shipments.find(s => s.id === shipmentId);
            if (!shipment) return;

            appState.delivered.unshift({...shipment, deliveredAt: new Date().toISOString()});
            appState.shipments = appState.shipments.filter(s => s.id !== shipmentId);
            saveToStorage('delivered');
            saveToStorage('shipments');
            renderCurrentPage();
            alert('Embarque marcado como entregado');
        }

        // ==================== MODALS ====================
        function openNewRequestModal() {
            document.getElementById('new-request-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('new-request-modal').classList.remove('active');
            document.getElementById('new-request-form').reset();
        }

        function submitNewRequest(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const newRequest = {
                id: `REQ-${String(appState.requests.length + 3001).padStart(4, '0')}`,
                requester: 'Usuario Actual',
                client: formData.get('client'),
                incoterm: formData.get('incoterm'),
                destination: formData.get('destination'),
                shipmentEtdMonth: formData.get('etdMonth'),
                items: [{product: formData.get('product'), volume: parseFloat(formData.get('volume'))}],
                status: 'BORRADOR',
                createdAt: new Date().toISOString()
            };

            appState.requests.unshift(newRequest);
            saveToStorage('requests');
            closeModal();
            navigateTo('requests');
            alert(`Solicitud ${newRequest.id} creada exitosamente`);
        }

        function openDrawer() {
            document.getElementById('drawer').classList.add('active');
            document.getElementById('drawer-overlay').classList.add('active');
        }

        function closeDrawer() {
            document.getElementById('drawer').classList.remove('active');
            document.getElementById('drawer-overlay').classList.remove('active');
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
