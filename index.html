<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Control - Marine Farm</title>
    <style>
        /* =========================
           MARINE FARM - ESTILOS ORIGINALES
           ========================= */
        :root {
          --mf-blue: #0c3e4d;
          --mf-blue-2: #205f6d;
          --mf-orange: #ff6c37;
          --mf-white: #ffffff;
          --mf-grey: #d6d1ca;
          --mf-grey-light: #f4f4f4;
          --mf-text: #073240;
          --mf-green: #41695b;
          --radius: 12px;
          --shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
          --font: "GT Walsheim Pro", "Aptos", "Arial", sans-serif;
        }

        * {
          box-sizing: border-box;
        }

        body {
          margin: 0;
          font-family: var(--font);
          background: var(--mf-grey-light);
          color: var(--mf-text);
        }

        /* Layout principal */
        .app-layout {
          display: flex;
          min-height: 100vh;
        }

        /* =========================
           SIDEBAR
           ========================= */
        .mf-sidebar {
          width: 260px;
          background: linear-gradient(180deg, #0c3e4d, #08303c);
          color: var(--mf-white);
          display: flex;
          flex-direction: column;
          padding: 18px 14px;
          position: sticky;
          top: 0;
          height: 100vh;
          overflow-y: auto;
        }

        .mf-sidebar-top {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
          margin-bottom: 24px;
          padding-left: 6px;
        }

        .mf-logo-white {
          width: 120px;
          height: auto;
        }

        .mf-logo-blue {
          width: 42px;
          height: 42px;
          object-fit: contain;
        }

        .mf-slogan {
          font-size: 11px;
          opacity: 0.85;
          line-height: 1.3;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.8px;
        }

        .mf-nav {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .mf-nav-section {
          margin-bottom: 20px;
        }

        .mf-nav-section-title {
          font-size: 10px;
          font-weight: 700;
          opacity: 0.6;
          text-transform: uppercase;
          letter-spacing: 1px;
          padding: 0 12px;
          margin-bottom: 8px;
        }

        .mf-nav-btn {
          background: transparent;
          border: none;
          color: var(--mf-white);
          text-align: left;
          padding: 10px 12px;
          border-radius: 10px;
          cursor: pointer;
          opacity: 0.88;
          font-family: var(--font);
          display: flex;
          flex-direction: column;
          gap: 2px;
          transition: all 0.2s;
        }

        .mf-nav-btn:hover {
          background: rgba(255, 255, 255, 0.08);
          opacity: 1;
        }

        .mf-nav-btn.active {
          background: rgba(255, 255, 255, 0.22);
          opacity: 1;
        }

        .mf-nav-btn .top {
          font-size: 14px;
          font-weight: 800;
          letter-spacing: 0.1px;
        }

        .mf-nav-btn .bottom {
          font-size: 11px;
          opacity: 0.75;
          font-weight: 650;
        }

        .mf-nav-btn-primary {
          background: rgba(255, 255, 255, 0.15);
          padding: 14px 14px;
        }

        .mf-sidebar-footer {
          margin-top: auto;
          font-size: 11px;
          opacity: 0.75;
          padding-top: 14px;
          padding-left: 6px;
        }

        /* =========================
           MAIN CONTENT
           ========================= */
        .mf-main {
          flex: 1;
          padding: 18px;
          overflow-y: auto;
        }

        .mf-topbar {
          background: var(--mf-white);
          border-radius: var(--radius);
          padding: 14px 18px;
          margin-bottom: 16px;
          box-shadow: var(--shadow);
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 16px;
          flex-wrap: wrap;
        }

        .mf-topbar-left {
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .mf-page-title {
          font-size: 26px;
          font-weight: 900;
          color: var(--mf-blue);
          line-height: 1.05;
          letter-spacing: 0.2px;
        }

        .mf-page-subtitle {
          margin-top: 4px;
          font-size: 13px;
          color: #5b848f;
          font-weight: 650;
        }

        /* =========================
           FILTERS
           ========================= */
        .mf-filters {
          display: flex;
          align-items: flex-end;
          gap: 10px;
          flex-wrap: wrap;
        }

        .mf-filter {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .mf-filter label {
          font-size: 11px;
          color: #5b848f;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .mf-filter input {
          height: 34px;
          border-radius: 10px;
          border: 1px solid var(--mf-grey);
          padding: 0 10px;
          font-size: 12px;
          background: var(--mf-white);
          color: var(--mf-text);
          outline: none;
          width: 150px;
          font-family: var(--font);
        }

        .mf-filter input:focus {
          border-color: var(--mf-blue);
        }

        /* =========================
           CARDS
           ========================= */
        .mf-card {
          background: var(--mf-white);
          border: 1px solid rgba(0, 0, 0, 0.06);
          border-radius: var(--radius);
          box-shadow: var(--shadow);
        }

        .mf-card-header {
          padding: 16px 18px;
          border-bottom: 1px solid rgba(0, 0, 0, 0.06);
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 12px;
        }

        .mf-h1 {
          margin: 0;
          font-size: 18px;
          color: var(--mf-blue);
          font-weight: 800;
          letter-spacing: 0.2px;
        }

        /* =========================
           BUTTONS
           ========================= */
        .mf-btn {
          border: none;
          border-radius: 10px;
          padding: 10px 14px;
          font-size: 13px;
          font-weight: 700;
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          font-family: var(--font);
          transition: all 0.2s;
        }

        .mf-btn-primary {
          background: var(--mf-orange);
          color: var(--mf-white);
        }

        .mf-btn-primary:hover {
          filter: brightness(0.96);
        }

        .mf-btn-secondary {
          background: var(--mf-white);
          border: 1px solid var(--mf-grey);
          color: var(--mf-blue);
        }

        .mf-btn-secondary:hover {
          border-color: var(--mf-blue);
        }

        .mf-btn-danger {
          background: #c0392b;
          color: var(--mf-white);
        }

        .mf-btn-small {
          padding: 6px 10px;
          font-size: 12px;
        }

        /* =========================
           PILLS / STATUS
           ========================= */
        .mf-pill {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: 2px 10px;
          border-radius: 999px;
          font-size: 11px;
          font-weight: 900;
          color: var(--mf-white);
          letter-spacing: 0.2px;
        }

        .mf-pill-blue { background: var(--mf-blue); }
        .mf-pill-orange { background: var(--mf-orange); }
        .mf-pill-green { background: var(--mf-green); }
        .mf-pill-red { background: #c0392b; }
        .mf-pill-yellow { background: #f1c40f; color: #0c3e4d; }

        /* =========================
           TABLES
           ========================= */
        .mf-table-container {
          overflow-x: auto;
        }

        .mf-table {
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }

        .mf-table th {
          text-align: left;
          padding: 10px;
          background: #f6f7f8;
          color: var(--mf-blue);
          font-weight: 900;
          letter-spacing: 0.15px;
          border-bottom: 2px solid rgba(0,0,0,0.08);
        }

        .mf-table td {
          padding: 10px;
          border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mf-table tbody tr {
          transition: background 0.15s;
        }

        .mf-table tbody tr:hover {
          background: #fafafa;
        }

        /* =========================
           KPI CARDS
           ========================= */
        .kpi-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
          gap: 14px;
          margin-bottom: 18px;
        }

        .kpi-card {
          background: var(--mf-white);
          border-radius: var(--radius);
          padding: 18px;
          box-shadow: var(--shadow);
          border: 1px solid rgba(0,0,0,0.06);
        }

        .kpi-label {
          font-size: 11px;
          font-weight: 700;
          color: #5b848f;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 8px;
        }

        .kpi-value {
          font-size: 36px;
          font-weight: 900;
          color: var(--mf-blue);
          line-height: 1;
          letter-spacing: -0.5px;
        }

        .kpi-trend {
          margin-top: 8px;
          font-size: 12px;
          font-weight: 650;
          color: #5b848f;
        }

        /* =========================
           MODAL / DRAWER
           ========================= */
        .mf-overlay {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.25);
          z-index: 40;
          display: none;
        }

        .mf-overlay.active {
          display: block;
        }

        .mf-drawer {
          position: fixed;
          top: 0;
          right: 0;
          height: 100vh;
          width: 420px;
          max-width: 90vw;
          background: var(--mf-white);
          border-left: 1px solid rgba(0, 0, 0, 0.08);
          box-shadow: -10px 0 30px rgba(0, 0, 0, 0.12);
          z-index: 50;
          display: none;
          flex-direction: column;
        }

        .mf-drawer.active {
          display: flex;
        }

        .mf-drawer-header {
          padding: 16px;
          border-bottom: 1px solid rgba(0, 0, 0, 0.06);
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          gap: 12px;
        }

        .mf-drawer-body {
          padding: 16px;
          overflow: auto;
          flex: 1;
        }

        .mf-kv {
          display: grid;
          grid-template-columns: 140px 1fr;
          gap: 10px 12px;
          font-size: 13px;
          margin-bottom: 16px;
        }

        .mf-kv .k {
          color: #5b848f;
          font-weight: 650;
        }

        .mf-kv .v {
          color: var(--mf-text);
          font-weight: 800;
        }

        /* Modal centrado */
        .mf-modal {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.4);
          z-index: 100;
          display: none;
          align-items: center;
          justify-content: center;
          padding: 20px;
        }

        .mf-modal.active {
          display: flex;
        }

        .mf-modal-content {
          background: var(--mf-white);
          border-radius: var(--radius);
          width: 100%;
          max-width: 700px;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .mf-modal-header {
          padding: 18px;
          border-bottom: 1px solid rgba(0,0,0,0.06);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .mf-modal-body {
          padding: 18px;
        }

        .mf-modal-footer {
          padding: 18px;
          border-top: 1px solid rgba(0,0,0,0.06);
          display: flex;
          justify-content: flex-end;
          gap: 10px;
        }

        /* =========================
           FORMS
           ========================= */
        .form-group {
          margin-bottom: 16px;
        }

        .form-label {
          display: block;
          font-size: 12px;
          font-weight: 700;
          color: var(--mf-text);
          margin-bottom: 6px;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .form-input,
        .form-select,
        .form-textarea {
          width: 100%;
          padding: 10px 12px;
          border: 1px solid var(--mf-grey);
          border-radius: 8px;
          font-size: 13px;
          font-family: var(--font);
          background: var(--mf-white);
          color: var(--mf-text);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
          outline: none;
          border-color: var(--mf-blue);
        }

        .form-textarea {
          min-height: 80px;
          resize: vertical;
        }

        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 12px;
        }

        /* =========================
           UTILITIES
           ========================= */
        .page {
          display: none;
        }

        .page.active {
          display: block;
        }

        .priority-dot {
          display: inline-block;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          margin-right: 6px;
        }

        .priority-1 { background: #c0392b; }
        .priority-2 { background: #f1c40f; }
        .priority-3 { background: var(--mf-green); }

        .text-muted {
          color: #5b848f;
        }

        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }

        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }

        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .gap-1 { gap: 8px; }
        .gap-2 { gap: 16px; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }

        /* Responsive */
        @media (max-width: 768px) {
          .app-layout {
            flex-direction: column;
          }

          .mf-sidebar {
            width: 100%;
            height: auto;
            position: relative;
          }

          .mf-topbar {
            flex-direction: column;
            align-items: flex-start;
          }

          .kpi-grid {
            grid-template-columns: 1fr;
          }

          .form-row {
            grid-template-columns: 1fr;
          }
        }

        .expand-section {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.3s ease;
        }

        .expand-section.open {
          max-height: 2000px;
        }

        .clickable {
          cursor: pointer;
        }

        .clickable:hover {
          background: #fafafa;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- SIDEBAR -->
        <aside class="mf-sidebar">
            <div class="mf-sidebar-top">
                <img src="logo-white.png" alt="Marine Farm" class="mf-logo-white">
                <div class="mf-slogan">Torre de Control</div>
            </div>

            <nav class="mf-nav">
                <div class="mf-nav-section">
                    <div class="mf-nav-section-title">Principal</div>
                    <button class="mf-nav-btn mf-nav-btn-primary active" onclick="navigateTo('dashboard')">
                        <span class="top">Dashboard</span>
                        <span class="bottom">Vista general</span>
                    </button>
                </div>

                <div class="mf-nav-section">
                    <div class="mf-nav-section-title">Operaciones</div>
                    <button class="mf-nav-btn" onclick="navigateTo('requests')">
                        <span class="top">Solicitudes</span>
                        <span class="bottom">Order requests</span>
                    </button>
                    <button class="mf-nav-btn" onclick="navigateTo('orders')">
                        <span class="top">Pedidos</span>
                        <span class="bottom">Backlog</span>
                    </button>
                    <button class="mf-nav-btn" onclick="navigateTo('shipments')">
                        <span class="top">En Tr√°nsito</span>
                        <span class="bottom">Contenedores</span>
                    </button>
                </div>

                <div class="mf-nav-section">
                    <div class="mf-nav-section-title">Reportes</div>
                    <button class="mf-nav-btn" onclick="navigateTo('payments')">
                        <span class="top">Pagos</span>
                        <span class="bottom">Cobranzas</span>
                    </button>
                    <button class="mf-nav-btn" onclick="navigateTo('kpi')">
                        <span class="top">KPI Comercial</span>
                        <span class="bottom">M√©tricas</span>
                    </button>
                </div>
            </nav>

            <div class="mf-sidebar-footer">
                v1.0.0 | Marine Farm 2026
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="mf-main">
            <!-- DASHBOARD PAGE -->
            <div id="page-dashboard" class="page active">
                <div class="mf-topbar">
                    <div class="mf-topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="mf-logo-blue">
                        <div>
                            <div class="mf-page-title">Dashboard Ejecutivo</div>
                            <div class="mf-page-subtitle">Panorama general de operaciones</div>
                        </div>
                    </div>
                    <div class="mf-filters">
                        <div class="mf-filter">
                            <label>Cliente</label>
                            <input type="text" id="global-filter-customer" placeholder="Buscar...">
                        </div>
                        <div class="mf-filter">
                            <label>Pa√≠s</label>
                            <input type="text" id="global-filter-country" placeholder="Pa√≠s...">
                        </div>
                        <button class="mf-btn mf-btn-secondary mf-btn-small" onclick="clearFilters()">
                            Limpiar
                        </button>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Pedidos Activos</div>
                        <div class="kpi-value" id="kpi-orders">0</div>
                        <div class="kpi-trend">En backlog</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">En Tr√°nsito</div>
                        <div class="kpi-value" id="kpi-shipments">0</div>
                        <div class="kpi-trend">Contenedores activos</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Volumen Mes (KG)</div>
                        <div class="kpi-value" id="kpi-volume">0</div>
                        <div class="kpi-trend">Pendiente despacho</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">ETA Hoy</div>
                        <div class="kpi-value" id="kpi-eta-today">0</div>
                        <div class="kpi-trend">Llegadas programadas</div>
                    </div>
                </div>

                <div class="mf-card">
                    <div class="mf-card-header">
                        <div class="mf-h1">Alertas Cr√≠ticas</div>
                    </div>
                    <div class="mf-table-container">
                        <table class="mf-table">
                            <thead>
                                <tr>
                                    <th>P</th>
                                    <th>PI</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Alerta</th>
                                </tr>
                            </thead>
                            <tbody id="alerts-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- REQUESTS PAGE -->
            <div id="page-requests" class="page">
                <div class="mf-topbar">
                    <div class="mf-topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="mf-logo-blue">
                        <div>
                            <div class="mf-page-title">Solicitudes de Pedido</div>
                            <div class="mf-page-subtitle">Gesti√≥n de order requests</div>
                        </div>
                    </div>
                    <button class="mf-btn mf-btn-primary" onclick="openNewRequestModal()">
                        ‚ûï Nueva Solicitud
                    </button>
                </div>

                <div class="mf-card">
                    <div class="mf-card-header">
                        <div class="mf-h1">Todas las Solicitudes</div>
                        <button class="mf-btn mf-btn-secondary mf-btn-small">
                            Exportar CSV
                        </button>
                    </div>
                    <div class="mf-table-container">
                        <table class="mf-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Destino</th>
                                    <th>ETD</th>
                                    <th>Volumen (KG)</th>
                                    <th>Estado</th>
                                    <th>Comercial</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="requests-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ORDERS PAGE -->
            <div id="page-orders" class="page">
                <div class="mf-topbar">
                    <div class="mf-topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="mf-logo-blue">
                        <div>
                            <div class="mf-page-title">Pedidos (Backlog)</div>
                            <div class="mf-page-subtitle">√ìrdenes confirmadas pendientes de embarque</div>
                        </div>
                    </div>
                </div>

                <div class="mf-card">
                    <div class="mf-card-header">
                        <div class="mf-h1">Todos los Pedidos</div>
                    </div>
                    <div class="mf-table-container">
                        <table class="mf-table">
                            <thead>
                                <tr>
                                    <th>P</th>
                                    <th>PI</th>
                                    <th>Cliente</th>
                                    <th>Pa√≠s</th>
                                    <th>Producto</th>
                                    <th>ETD</th>
                                    <th>Pendiente KG</th>
                                    <th>USD/KG</th>
                                    <th>SI</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SHIPMENTS PAGE -->
            <div id="page-shipments" class="page">
                <div class="mf-topbar">
                    <div class="mf-topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="mf-logo-blue">
                        <div>
                            <div class="mf-page-title">Embarques en Tr√°nsito</div>
                            <div class="mf-page-subtitle">Seguimiento de contenedores</div>
                        </div>
                    </div>
                </div>

                <div class="mf-card">
                    <div class="mf-card-header">
                        <div class="mf-h1">Contenedores Activos</div>
                    </div>
                    <div class="mf-table-container">
                        <table class="mf-table">
                            <thead>
                                <tr>
                                    <th>Booking</th>
                                    <th>PI</th>
                                    <th>Cliente</th>
                                    <th>Destino</th>
                                    <th>ETD</th>
                                    <th>ETA</th>
                                    <th>KG</th>
                                    <th>Docs</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="shipments-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PAYMENTS PAGE -->
            <div id="page-payments" class="page">
                <div class="mf-topbar">
                    <div class="mf-topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="mf-logo-blue">
                        <div>
                            <div class="mf-page-title">Status de Pagos</div>
                            <div class="mf-page-subtitle">Control de cobranzas</div>
                        </div>
                    </div>
                </div>

                <div class="mf-card">
                    <div class="mf-card-header">
                        <div class="mf-h1">Por Cliente</div>
                    </div>
                    <div class="mf-table-container">
                        <table class="mf-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Deuda USD</th>
                                    <th>L√≠nea Cr√©dito</th>
                                    <th>Disponible</th>
                                    <th>D√≠as Atraso</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="payments-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- KPI PAGE -->
            <div id="page-kpi" class="page">
                <div class="mf-topbar">
                    <div class="mf-topbar-left">
                        <img src="logo-blue.png" alt="Marine Farm" class="mf-logo-blue">
                        <div>
                            <div class="mf-page-title">KPI Comercial</div>
                            <div class="mf-page-subtitle">M√©tricas de desempe√±o</div>
                        </div>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">√ìrdenes Cerradas (Mes)</div>
                        <div class="kpi-value" id="kpi-closed">0</div>
                        <div class="kpi-trend">Meta: 25</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Volumen Exportado (KG)</div>
                        <div class="kpi-value" id="kpi-exported">0</div>
                        <div class="kpi-trend">Este mes</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">OTIF %</div>
                        <div class="kpi-value" id="kpi-otif">0%</div>
                        <div class="kpi-trend">On-Time In-Full</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Margen Promedio</div>
                        <div class="kpi-value" id="kpi-margin">$0</div>
                        <div class="kpi-trend">USD/KG</div>
                    </div>
                </div>

                <div class="mf-card mb-2">
                    <div class="mf-card-header">
                        <div class="mf-h1">Mix de Especies</div>
                    </div>
                    <div style="padding: 24px;">
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 700; margin-bottom: 8px;">Atlantic Salmon</div>
                            <div style="background: var(--mf-blue); height: 32px; border-radius: 8px; width: 70%;"></div>
                            <div class="text-muted" style="font-size: 12px; margin-top: 4px;">70% del volumen</div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: 700; margin-bottom: 8px;">Coho Salmon</div>
                            <div style="background: var(--mf-orange); height: 32px; border-radius: 8px; width: 25%;"></div>
                            <div class="text-muted" style="font-size: 12px; margin-top: 4px;">25% del volumen</div>
                        </div>
                        <div>
                            <div style="font-weight: 700; margin-bottom: 8px;">Otros</div>
                            <div style="background: var(--mf-grey); height: 32px; border-radius: 8px; width: 5%;"></div>
                            <div class="text-muted" style="font-size: 12px; margin-top: 4px;">5% del volumen</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- NEW REQUEST MODAL -->
    <div id="new-request-modal" class="mf-modal">
        <div class="mf-modal-content">
            <div class="mf-modal-header">
                <div class="mf-h1">Nueva Solicitud de Pedido</div>
                <button class="mf-btn mf-btn-secondary mf-btn-small" onclick="closeNewRequestModal()">‚úï</button>
            </div>
            <form id="new-request-form" onsubmit="submitNewRequest(event)">
                <div class="mf-modal-body">
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <input type="text" class="form-input" name="client" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Incoterm *</label>
                            <select class="form-select" name="incoterm" required>
                                <option value="CFR">CFR</option>
                                <option value="FOB">FOB</option>
                                <option value="CIF">CIF</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Destino *</label>
                            <input type="text" class="form-input" name="destination" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ETD Mes *</label>
                            <input type="month" class="form-input" name="etdMonth" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Volumen (KG) *</label>
                            <input type="number" class="form-input" name="volume" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Producto *</label>
                        <input type="text" class="form-input" name="product" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Precio (USD/KG) *</label>
                        <input type="number" step="0.01" class="form-input" name="price" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comentarios</label>
                        <textarea class="form-textarea" name="comments"></textarea>
                    </div>
                </div>
                <div class="mf-modal-footer">
                    <button type="button" class="mf-btn mf-btn-secondary" onclick="closeNewRequestModal()">Cancelar</button>
                    <button type="submit" class="mf-btn mf-btn-primary">‚úì Crear Solicitud</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SIDE PANEL (for details) -->
    <div id="side-panel-overlay" class="mf-overlay" onclick="closeSidePanel()"></div>
    <div id="side-panel" class="mf-drawer">
        <div class="mf-drawer-header">
            <div class="mf-h1" id="panel-title">Detalles</div>
            <button class="mf-btn mf-btn-secondary mf-btn-small" onclick="closeSidePanel()">‚úï</button>
        </div>
        <div class="mf-drawer-body" id="panel-body">
        </div>
    </div>

    <script>
        // ==================== DATA STORAGE ====================
        const STORAGE_KEYS = {
            orders: 'mf.orders.v1',
            requests: 'mf.requests.v1',
            shipments: 'mf.shipments.v1',
            delivered: 'mf.delivered.v1',
            payments: 'mf.payments.v1'
        };

        // ==================== SEED DATA ====================
        const seedData = {
            requests: [
                {
                    id: 'REQ-3001',
                    requester: 'Nicolas',
                    client: 'Vietnam Importer A',
                    consignee: 'VIETNAM IMPORTER A CO., LTD.',
                    notify: 'VIETNAM IMPORTER A - LOGISTICS',
                    incoterm: 'CFR',
                    destination: 'HCMC, Vietnam',
                    shipmentEtdMonth: '2026-02',
                    paymentMethod: 'Payment Against Docs',
                    items: [{product: 'Coho HG IQF', quality: 'Premium', size: '9 lbs Up', price: 6.8, volume: 20000}],
                    status: 'ENVIADA',
                    createdAt: '2026-01-15T10:00:00Z'
                },
                {
                    id: 'REQ-3002',
                    requester: 'Nicolas',
                    client: 'Thai Distributor A',
                    incoterm: 'CFR',
                    destination: 'Bangkok, Thailand',
                    shipmentEtdMonth: '2026-02',
                    items: [{product: 'Atlantic HON', quality: 'Premium', size: '6-7', price: 2.55, volume: 20000}],
                    status: 'EN_REVISION',
                    createdAt: '2026-01-18T14:30:00Z'
                }
            ],
            orders: [
                {
                    id: 'ORD-001',
                    pi: 'PI-45621',
                    customer: 'Vietnam Importer A',
                    country: 'VIETNAM',
                    destination: 'CFR HCMC',
                    product: 'Coho HG IQF 9lbs Up',
                    plant: 'QUELLON 10751',
                    etd: '2026-02-15',
                    pendingKg: 20000,
                    priceUsdPerKg: 6.80,
                    priority: 1,
                    commercial: 'Nicolas',
                    shippingInstructionsOk: false
                },
                {
                    id: 'ORD-002',
                    pi: 'PI-45622',
                    customer: 'Thai Distributor A',
                    country: 'THAILAND',
                    destination: 'CFR Bangkok',
                    product: 'Atlantic HON 6-7',
                    plant: 'QUELLON 10751',
                    etd: '2026-02-20',
                    pendingKg: 20000,
                    priceUsdPerKg: 5.62,
                    priority: 2,
                    commercial: 'Nicolas',
                    shippingInstructionsOk: true
                }
            ],
            shipments: [
                {
                    id: 'SHIP-001',
                    orderId: 'ORD-003',
                    pi: 'PI-45618',
                    booking: 'MAEU9876543',
                    customer: 'China Trader A',
                    country: 'CHINA',
                    destination: 'CFR Shanghai',
                    product: 'Atlantic HON Mix',
                    etd: '2026-01-15',
                    eta: '2026-02-05',
                    shippedKg: 20000,
                    docsStatus: 'OK',
                    priceUsdPerKg: 5.45
                },
                {
                    id: 'SHIP-002',
                    orderId: 'ORD-004',
                    pi: 'PI-45619',
                    booking: 'COSU1234567',
                    customer: 'Korea Fish Co',
                    country: 'KOREA',
                    destination: 'CFR Busan',
                    product: 'Coho Portions',
                    etd: '2026-01-20',
                    eta: '2026-01-30',
                    shippedKg: 18000,
                    docsStatus: 'PEND',
                    priceUsdPerKg: 6.95
                }
            ],
            delivered: [],
            payments: [
                {
                    id: 'PAY-001',
                    customer: 'Vietnam Importer A',
                    debtUsd: 145000,
                    creditLineUsd: 300000,
                    invoices: [
                        {number: 'INV-2601', date: '2025-11-15', amount: 85000, daysOverdue: 45},
                        {number: 'INV-2612', date: '2025-12-20', amount: 60000, daysOverdue: 10}
                    ]
                },
                {
                    id: 'PAY-002',
                    customer: 'Thai Distributor A',
                    debtUsd: 95000,
                    creditLineUsd: 200000,
                    invoices: [
                        {number: 'INV-2605', date: '2025-12-01', amount: 95000, daysOverdue: 29}
                    ]
                }
            ]
        };

        // ==================== STATE ====================
        let appState = {
            requests: [],
            orders: [],
            shipments: [],
            delivered: [],
            payments: [],
            filters: {
                customer: '',
                country: ''
            }
        };

        // ==================== INIT ====================
        function initApp() {
            // Load from localStorage or use seed
            Object.keys(STORAGE_KEYS).forEach(key => {
                const stored = localStorage.getItem(STORAGE_KEYS[key]);
                appState[key] = stored ? JSON.parse(stored) : seedData[key] || [];
            });

            // Event listeners for filters
            document.getElementById('global-filter-customer')?.addEventListener('input', (e) => {
                appState.filters.customer = e.target.value;
                renderCurrentPage();
            });

            document.getElementById('global-filter-country')?.addEventListener('input', (e) => {
                appState.filters.country = e.target.value;
                renderCurrentPage();
            });

            renderCurrentPage();
        }

        function saveToStorage(key) {
            localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(appState[key]));
        }

        // ==================== NAVIGATION ====================
        function navigateTo(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // Show selected
            document.getElementById(`page-${pageName}`).classList.add('active');
            // Update nav
            document.querySelectorAll('.mf-nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.mf-nav-btn')?.classList.add('active');
            // Render
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const activePage = document.querySelector('.page.active');
            if (!activePage) return;

            const pageId = activePage.id;

            switch(pageId) {
                case 'page-dashboard':
                    renderDashboard();
                    break;
                case 'page-requests':
                    renderRequests();
                    break;
                case 'page-orders':
                    renderOrders();
                    break;
                case 'page-shipments':
                    renderShipments();
                    break;
                case 'page-payments':
                    renderPayments();
                    break;
                case 'page-kpi':
                    renderKPI();
                    break;
            }
        }

        // ==================== FILTERS ====================
        function clearFilters() {
            appState.filters = {customer: '', country: ''};
            document.getElementById('global-filter-customer').value = '';
            document.getElementById('global-filter-country').value = '';
            renderCurrentPage();
        }

        function applyFilters(items) {
            return items.filter(item => {
                const customer = (item.customer || item.client || '').toLowerCase();
                const country = (item.country || item.destination || '').toLowerCase();

                if (appState.filters.customer && !customer.includes(appState.filters.customer.toLowerCase())) {
                    return false;
                }
                if (appState.filters.country && !country.includes(appState.filters.country.toLowerCase())) {
                    return false;
                }
                return true;
            });
        }

        // ==================== UTILITIES ====================
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('es-CL');
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('es-CL').format(num || 0);
        }

        function calculateEtaDays(etaStr) {
            if (!etaStr) return null;
            const today = new Date();
            today.setHours(0,0,0,0);
            const eta = new Date(etaStr);
            eta.setHours(0,0,0,0);
            const diff = eta - today;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function getStatusClass(status) {
            const map = {
                'OK': 'mf-pill-green',
                'PEND': 'mf-pill-yellow',
                'PENDIENTE': 'mf-pill-yellow',
                'DRAFT ENVIADO': 'mf-pill-blue',
                'ENVIADA': 'mf-pill-blue',
                'EN_REVISION': 'mf-pill-orange',
                'PI CREADA': 'mf-pill-green',
                'BORRADOR': 'mf-pill-yellow'
            };
            return map[status] || 'mf-pill-blue';
        }

        // ==================== DASHBOARD ====================
        function renderDashboard() {
            const filtered = {
                orders: applyFilters(appState.orders),
                shipments: applyFilters(appState.shipments)
            };

            // KPIs
            document.getElementById('kpi-orders').textContent = filtered.orders.length;
            document.getElementById('kpi-shipments').textContent = filtered.shipments.length;

            const totalVolume = filtered.orders.reduce((sum, o) => sum + (o.pendingKg || 0), 0);
            document.getElementById('kpi-volume').textContent = formatNumber(totalVolume);

            const etaToday = filtered.shipments.filter(s => calculateEtaDays(s.eta) === 0).length;
            document.getElementById('kpi-eta-today').textContent = etaToday;

            // Alerts
            const alerts = [];

            // Shipping Instructions pendientes
            filtered.orders.filter(o => !o.shippingInstructionsOk).slice(0,3).forEach(o => {
                alerts.push({
                    priority: o.priority,
                    pi: o.pi,
                    customer: o.customer,
                    type: 'SI PEND',
                    message: 'Shipping Instructions pendientes'
                });
            });

            // Docs pendientes
            filtered.shipments.filter(s => s.docsStatus !== 'OK').slice(0,2).forEach(s => {
                alerts.push({
                    priority: 2,
                    pi: s.pi,
                    customer: s.customer,
                    type: 'DOCS',
                    message: 'Documentos pendientes'
                });
            });

            const tbody = document.getElementById('alerts-tbody');
            if (alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: #5b848f;">‚úì No hay alertas cr√≠ticas</td></tr>';
            } else {
                tbody.innerHTML = alerts.map(a => `
                    <tr>
                        <td><span class="priority-dot priority-${a.priority}"></span></td>
                        <td><strong>${a.pi}</strong></td>
                        <td>${a.customer}</td>
                        <td><span class="mf-pill ${getStatusClass(a.type)}">${a.type}</span></td>
                        <td>${a.message}</td>
                    </tr>
                `).join('');
            }
        }

        // ==================== REQUESTS ====================
        function renderRequests() {
            const filtered = applyFilters(appState.requests);
            const tbody = document.getElementById('requests-tbody');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 40px; color: #5b848f;">No hay solicitudes</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(r => {
                const totalVolume = r.items.reduce((sum, i) => sum + (i.volume || 0), 0);
                return `
                    <tr class="clickable" onclick="viewRequestDetails('${r.id}')">
                        <td><strong>${r.id}</strong></td>
                        <td>${r.client}</td>
                        <td>${r.incoterm} ${r.destination}</td>
                        <td>${r.shipmentEtdMonth}</td>
                        <td>${formatNumber(totalVolume)}</td>
                        <td><span class="mf-pill ${getStatusClass(r.status)}">${r.status}</span></td>
                        <td>${r.requester}</td>
                        <td>
                            ${r.status === 'ENVIADA' || r.status === 'EN_REVISION' ? 
                                `<button class="mf-btn mf-btn-primary mf-btn-small" onclick="approveRequest('${r.id}', event)">‚úì Aprobar</button>` : 
                                ''}
                            <button class="mf-btn mf-btn-danger mf-btn-small" onclick="deleteRequest('${r.id}', event)">üóë</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewRequestDetails(requestId) {
            const request = appState.requests.find(r => r.id === requestId);
            if (!request) return;

            const totalVolume = request.items.reduce((sum, i) => sum + (i.volume || 0), 0);

            document.getElementById('panel-title').textContent = `Solicitud ${request.id}`;
            document.getElementById('panel-body').innerHTML = `
                <div class="mf-kv">
                    <div class="k">Cliente</div>
                    <div class="v">${request.client}</div>

                    <div class="k">Estado</div>
                    <div class="v"><span class="mf-pill ${getStatusClass(request.status)}">${request.status}</span></div>

                    <div class="k">Destino</div>
                    <div class="v">${request.incoterm} ${request.destination}</div>

                    <div class="k">ETD</div>
                    <div class="v">${request.shipmentEtdMonth}</div>

                    <div class="k">Volumen Total</div>
                    <div class="v">${formatNumber(totalVolume)} KG</div>

                    <div class="k">Comercial</div>
                    <div class="v">${request.requester}</div>
                </div>

                <div style="margin-top: 20px;">
                    <div class="mf-h1 mb-1">Items</div>
                    ${request.items.map(item => `
                        <div style="padding: 12px; background: #f6f7f8; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 800; margin-bottom: 4px;">${item.product}</div>
                            <div style="font-size: 12px; color: #5b848f;">
                                ${item.quality} | ${item.size} | ${formatNumber(item.volume)} kg | $${item.price}/kg
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            openSidePanel();
        }

        function approveRequest(requestId, event) {
            event?.stopPropagation();
            if (!confirm('¬øAprobar esta solicitud y crear pedido?')) return;

            const request = appState.requests.find(r => r.id === requestId);
            if (!request) return;

            // Create order
            const totalVolume = request.items.reduce((sum, i) => sum + (i.volume || 0), 0);
            const avgPrice = request.items.reduce((sum, i) => sum + (i.price * i.volume), 0) / totalVolume;

            const newOrder = {
                id: `ORD-${String(appState.orders.length + 1).padStart(3, '0')}`,
                pi: `PI-${Math.floor(10000 + Math.random() * 90000)}`,
                customer: request.client,
                country: guessCountry(request.destination),
                destination: `${request.incoterm} ${request.destination}`,
                product: request.items[0].product,
                plant: 'QUELLON 10751',
                etd: `${request.shipmentEtdMonth}-15`,
                pendingKg: totalVolume,
                priceUsdPerKg: avgPrice,
                priority: 2,
                commercial: request.requester,
                shippingInstructionsOk: request.consignee ? true : false
            };

            appState.orders.unshift(newOrder);
            request.status = 'PI CREADA';
            request.pi = newOrder.pi;

            saveToStorage('orders');
            saveToStorage('requests');

            renderCurrentPage();
            alert(`Pedido ${newOrder.pi} creado exitosamente`);
        }

        function deleteRequest(requestId, event) {
            event?.stopPropagation();
            if (!confirm('¬øEliminar esta solicitud?')) return;

            appState.requests = appState.requests.filter(r => r.id !== requestId);
            saveToStorage('requests');
            renderCurrentPage();
        }

        function guessCountry(destination) {
            const d = destination.toLowerCase();
            if (d.includes('vietnam') || d.includes('hcmc') || d.includes('ho chi minh')) return 'VIETNAM';
            if (d.includes('china') || d.includes('shanghai') || d.includes('beijing')) return 'CHINA';
            if (d.includes('korea') || d.includes('busan') || d.includes('seoul')) return 'KOREA';
            if (d.includes('thailand') || d.includes('bangkok')) return 'THAILAND';
            if (d.includes('japan') || d.includes('tokyo')) return 'JAPAN';
            return 'OTRO';
        }

        // ==================== ORDERS ====================
        function renderOrders() {
            const filtered = applyFilters(appState.orders);
            const tbody = document.getElementById('orders-tbody');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 40px; color: #5b848f;">No hay pedidos</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(o => `
                <tr>
                    <td><span class="priority-dot priority-${o.priority}"></span></td>
                    <td><strong>${o.pi}</strong></td>
                    <td>${o.customer}</td>
                    <td>${o.country}</td>
                    <td>${o.product}</td>
                    <td>${formatDate(o.etd)}</td>
                    <td>${formatNumber(o.pendingKg)}</td>
                    <td>$${o.priceUsdPerKg.toFixed(2)}</td>
                    <td><span class="mf-pill ${o.shippingInstructionsOk ? 'mf-pill-green' : 'mf-pill-yellow'}">${o.shippingInstructionsOk ? 'OK' : 'PEND'}</span></td>
                    <td>
                        <button class="mf-btn mf-btn-primary mf-btn-small" onclick="shipOrder('${o.id}')">üö¢ Embarcar</button>
                    </td>
                </tr>
            `).join('');
        }

        function shipOrder(orderId) {
            const order = appState.orders.find(o => o.id === orderId);
            if (!order) return;

            const booking = prompt('Ingrese n√∫mero de booking:');
            if (!booking) return;

            const eta = prompt('Ingrese ETA (YYYY-MM-DD):');
            if (!eta) return;

            const newShipment = {
                id: `SHIP-${String(appState.shipments.length + 1).padStart(3, '0')}`,
                orderId: order.id,
                pi: order.pi,
                booking: booking,
                customer: order.customer,
                country: order.country,
                destination: order.destination,
                product: order.product,
                etd: order.etd,
                eta: eta,
                shippedKg: order.pendingKg,
                docsStatus: 'PEND',
                priceUsdPerKg: order.priceUsdPerKg
            };

            appState.shipments.unshift(newShipment);
            appState.orders = appState.orders.filter(o => o.id !== orderId);

            saveToStorage('shipments');
            saveToStorage('orders');

            alert(`Embarque ${newShipment.booking} creado exitosamente`);
            navigateTo('shipments');
        }

        // ==================== SHIPMENTS ====================
        function renderShipments() {
            const filtered = applyFilters(appState.shipments);
            const tbody = document.getElementById('shipments-tbody');

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding: 40px; color: #5b848f;">No hay embarques</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(s => `
                <tr>
                    <td><strong>${s.booking}</strong></td>
                    <td>${s.pi || '-'}</td>
                    <td>${s.customer}</td>
                    <td>${s.destination}</td>
                    <td>${formatDate(s.etd)}</td>
                    <td>${formatDate(s.eta)}</td>
                    <td>${formatNumber(s.shippedKg)}</td>
                    <td><span class="mf-pill ${getStatusClass(s.docsStatus)}">${s.docsStatus}</span></td>
                    <td>
                        <button class="mf-btn mf-btn-primary mf-btn-small" onclick="confirmDelivery('${s.id}')">‚úì Entregado</button>
                    </td>
                </tr>
            `).join('');
        }

        function confirmDelivery(shipmentId) {
            if (!confirm('¬øConfirmar entrega de este embarque?')) return;

            const shipment = appState.shipments.find(s => s.id === shipmentId);
            if (!shipment) return;

            appState.delivered.unshift({
                ...shipment,
                deliveredAt: new Date().toISOString()
            });

            appState.shipments = appState.shipments.filter(s => s.id !== shipmentId);

            saveToStorage('delivered');
            saveToStorage('shipments');

            renderCurrentPage();
            alert('Embarque marcado como entregado');
        }

        // ==================== PAYMENTS ====================
        function renderPayments() {
            const tbody = document.getElementById('payments-tbody');

            if (appState.payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px; color: #5b848f;">No hay datos de pagos</td></tr>';
                return;
            }

            tbody.innerHTML = appState.payments.map((p, idx) => {
                const available = p.creditLineUsd - p.debtUsd;
                const maxDays = Math.max(...p.invoices.map(i => i.daysOverdue || 0));
                const daysClass = maxDays > 60 ? 'mf-pill-red' : maxDays > 30 ? 'mf-pill-yellow' : 'mf-pill-green';

                return `
                    <tr>
                        <td><strong>${p.customer}</strong></td>
                        <td>$${formatNumber(p.debtUsd)}</td>
                        <td>$${formatNumber(p.creditLineUsd)}</td>
                        <td>$${formatNumber(available)}</td>
                        <td><span class="mf-pill ${daysClass}">${maxDays} d√≠as</span></td>
                        <td>
                            <button class="mf-btn mf-btn-secondary mf-btn-small" onclick="togglePaymentDetail(${idx})">
                                Ver Detalle
                            </button>
                        </td>
                    </tr>
                    <tr id="payment-detail-${idx}" class="expand-section">
                        <td colspan="6" style="padding: 0;">
                            <div style="padding: 16px; background: #f6f7f8;">
                                <div style="font-weight: 700; margin-bottom: 8px;">Facturas Pendientes:</div>
                                ${p.invoices.map(inv => `
                                    <div style="padding: 8px; background: white; border-radius: 6px; margin-bottom: 6px; font-size: 12px;">
                                        <strong>${inv.number}</strong> - 
                                        Fecha: ${inv.date} - 
                                        Monto: $${formatNumber(inv.amount)} - 
                                        <span class="mf-pill ${inv.daysOverdue > 60 ? 'mf-pill-red' : inv.daysOverdue > 30 ? 'mf-pill-yellow' : 'mf-pill-green'}">
                                            ${inv.daysOverdue} d√≠as
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function togglePaymentDetail(idx) {
            const detail = document.getElementById(`payment-detail-${idx}`);
            detail.classList.toggle('open');
        }

        // ==================== KPI ====================
        function renderKPI() {
            const closedThisMonth = appState.delivered.filter(d => {
                const deliveredDate = new Date(d.deliveredAt);
                const now = new Date();
                return deliveredDate.getMonth() === now.getMonth() && 
                       deliveredDate.getFullYear() === now.getFullYear();
            });

            document.getElementById('kpi-closed').textContent = closedThisMonth.length;

            const exportedKg = closedThisMonth.reduce((sum, d) => sum + (d.shippedKg || 0), 0);
            document.getElementById('kpi-exported').textContent = formatNumber(exportedKg);

            const otif = closedThisMonth.length > 0 ? 92 : 0;
            document.getElementById('kpi-otif').textContent = `${otif}%`;

            const avgMargin = closedThisMonth.length > 0
                ? closedThisMonth.reduce((sum, d) => sum + (d.priceUsdPerKg || 0), 0) / closedThisMonth.length
                : 0;
            document.getElementById('kpi-margin').textContent = `$${avgMargin.toFixed(2)}`;
        }

        // ==================== MODALS ====================
        function openNewRequestModal() {
            document.getElementById('new-request-modal').classList.add('active');
        }

        function closeNewRequestModal() {
            document.getElementById('new-request-modal').classList.remove('active');
            document.getElementById('new-request-form').reset();
        }

        function submitNewRequest(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const newRequest = {
                id: `REQ-${String(appState.requests.length + 3001).padStart(4, '0')}`,
                requester: 'Usuario Actual',
                client: formData.get('client'),
                incoterm: formData.get('incoterm'),
                destination: formData.get('destination'),
                shipmentEtdMonth: formData.get('etdMonth'),
                items: [{
                    product: formData.get('product'),
                    quality: 'Premium',
                    size: 'TBD',
                    price: parseFloat(formData.get('price')),
                    volume: parseFloat(formData.get('volume'))
                }],
                status: 'BORRADOR',
                createdAt: new Date().toISOString(),
                comments: formData.get('comments') || ''
            };

            appState.requests.unshift(newRequest);
            saveToStorage('requests');

            closeNewRequestModal();
            navigateTo('requests');
            alert(`Solicitud ${newRequest.id} creada exitosamente`);
        }

        function openSidePanel() {
            document.getElementById('side-panel').classList.add('active');
            document.getElementById('side-panel-overlay').classList.add('active');
        }

        function closeSidePanel() {
            document.getElementById('side-panel').classList.remove('active');
            document.getElementById('side-panel-overlay').classList.remove('active');
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
